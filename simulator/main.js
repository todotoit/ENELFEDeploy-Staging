function init(){function a(){var a=null;return document.querySelectorAll(".placeholder").forEach(function(b){a||"true"==b.dataset.empty&&(a=b)}),a||c}function b(b){var c=document.querySelector("#"+b.dataset.element),d=a(),e=d.getBoundingClientRect(),f=b.getBoundingClientRect();c.style.transform="translate(0,0)";var g=c.getBoundingClientRect().x,h=c.getBoundingClientRect().y;c.style.transform="translate("+(f.x-g)+"px,"+(f.y-h)+"px)";var i=e.x-g,j=e.y-h;setTimeout(function(){c.classList.add("moving"),c.style.transform="translate("+i+"px,"+j+"px)",setTimeout(function(){c.classList.remove("moving")},300)},0),d.dataset.empty=!1,b.dataset.empty=!0,d.dataset.element=c.getAttribute("id"),b.dataset.element="",c.setAttribute("data-x",i),c.setAttribute("data-y",j),APP.deselect(c.dataset.appId,b.dataset.readerId)}interact.maxInteractions(1),document.querySelectorAll(".placeholder").forEach(function(a,b){a.dataset.empty=!1,a.dataset.element="app"+(b+1)}),document.querySelectorAll(".dropzone").forEach(function(a,b){a.dataset.empty=!0,a.dataset.element="",a.dataset.readerId=b+1}),document.querySelectorAll(".draggable").forEach(function(a,b){a.dataset.appId=b});var c=null,d=null;interact(".draggable").draggable({inertia:!0,max:1,restrict:{restriction:function(e,f,g){var h=document.querySelector("#apppliances");return!g.element.classList.contains("can-drop")||"true"!==d.dataset.empty&&d.dataset.element!==g.element.getAttribute("id")?g.element.classList.contains("can-drop")&&"false"===d.dataset.empty?(APP.deselect(g.element.dataset.appId,c.dataset.readerId),b(d),h=d,APP.select(g.element.dataset.appId,d.dataset.readerId)):(APP.deselect(g.element.dataset.appId,c.dataset.readerId),h=a()):(c&&APP.deselect(g.element.dataset.appId,c.dataset.readerId),h=d,APP.select(g.element.dataset.appId,d.dataset.readerId)),h},endOnly:!0,elementRect:{top:0,left:0,bottom:1,right:1}},autoScroll:!1}).on("dragstart",function(a){a.interaction.x=parseInt(a.target.getAttribute("data-x"),10)||0,a.interaction.y=parseInt(a.target.getAttribute("data-y"),10)||0}).on("dragmove",function(a){var b=a.target;a.interaction.x+=a.dx,a.interaction.y+=a.dy,b.classList.add("over"),b.style.transform="translate("+a.interaction.x+"px, "+a.interaction.y+"px)"}).on("dragend",function(a){a.target.setAttribute("data-x",a.interaction.x),a.target.setAttribute("data-y",a.interaction.y),a.target.classList.remove("over")}),interact(".dropzone, .placeholder").dropzone({accept:".drag-drop",overlap:.5,ondropactivate:function(a){a.target.classList.add("drop-active")},ondragenter:function(a){var b=a.relatedTarget,c=a.target;d=c,c.classList.add("drop-target"),b.classList.add("can-drop")},ondragleave:function(a){a.target.classList.remove("drop-target"),a.relatedTarget.classList.remove("can-drop"),c||(c=a.target,c.dataset.empty=!0,c.dataset.element="")},ondrop:function(a){c=null,d.dataset.empty=!1,d.dataset.element=a.relatedTarget.getAttribute("id"),a.relatedTarget.classList.remove("can-drop")},ondropdeactivate:function(a){a.target.classList.remove("drop-active"),a.target.classList.remove("drop-target")}})}!function(a,b,c,d){"use strict";function e(a){var b=a.values,c={key:a.key,values:b.map(function(a){return{v:0}})};return c}function f(a,f){if(c.isEmpty(a))return console.error("data is empty");l=b(i).append(Z).find("svg#teamAreaChart"),m=l.attr("viewBox").split(" "),n=+m[2],p=+m[3],p+=20,q=30,r=75,o=n-r,l=d.select(l.get(0)),t=l.append("defs");var g=t.append("linearGradient").attr("id","teamAreaChart_mask_grad").attr("gradientUnits","userSpaceOnUse").attr("x1",0).attr("y1",0).attr("x2",o).attr("y2",0);g.append("stop").attr("offset",0).attr("stop-color","#000000"),g.append("stop").attr("offset",q/o).attr("stop-color","#000000"),g.append("stop").attr("offset",q/o).attr("stop-color","#ffffff"),g.append("stop").attr("offset",1-.6*q/o).attr("stop-color","#ffffff"),g.append("stop").attr("offset",1-q/o).attr("stop-color","#000000"),g.append("stop").attr("offset",1).attr("stop-color","#000000"),j=t.append("mask").attr("id","mask-border"),k=t.append("mask").attr("id","mask-area"),k.append("path").attr("class","area area-mask"),j.append("rect").attr("x",0).attr("y",0).attr("width",o).attr("height",p).attr("fill","url(#teamAreaChart_mask_grad)"),u=t.append("linearGradient").attr("id","areaGrd").attr("gradientUnits","userSpaceOnUse").attr("x1",0).attr("y1",q).attr("x2",0).attr("y2",p-q),u.append("stop").attr("offset",0).attr("stop-color","#FF006E"),u.append("stop").attr("offset",1-(M+M/1.5)).attr("stop-color","#FF006E"),u.append("stop").attr("offset",1-M).attr("stop-color","#5738FF"),u.append("stop").attr("offset",1).attr("stop-color","#ffffff"),v=t.append("linearGradient").attr("id","storAreaGrd").attr("gradientUnits","userSpaceOnUse").attr("x1",0).attr("y1",q).attr("x2",0).attr("y2",p-q),v.append("stop").attr("offset",0).attr("stop-color","#FF006E"),v.append("stop").attr("offset",1-(M+M/1.5)).attr("stop-color","#FF006E"),v.append("stop").attr("class","storstop").attr("offset",1-M).attr("stop-color","#5738FF"),w=l.append("g").attr("class","areas").attr("mask","url(#mask-border)"),z=w.append("g").attr("class","areaIntersection").attr("mask","url(#mask-area)"),x=w.append("g").attr("class","areaTot"),y=w.append("g").attr("class","areaStorage"),A=l.append("g").attr("class","toplines").attr("mask","url(#mask-border)"),D=l.append("g").attr("class","circles"),E=l.append("g").attr("class","labels"),c.each(a,function(a){x.append("path").attr("class","area area-"+c.kebabCase(a.key)),y.append("path").attr("class","area area-"+c.kebabCase(a.key)),A.append("path").attr("class","arealine line-"+c.kebabCase(a.key)),E.append("g").attr("class","label label-area label-"+c.kebabCase(a.key))}),z.append("path").attr("class","area area-intersection"),B=A.append("g").attr("class","topline").append("path"),C=A.append("g").attr("class","topline storage").append("path"),D.append("circle").attr("class","topcircle"),E.append("g").attr("class","label toplabel").append("text").text("Energy demand"),D.append("circle").attr("class","storcircle"),E.append("g").attr("class","label storlabel").append("text").text("Energy from the grid"),A.append("line").attr("class","threshold"),A.append("line").attr("class","danger"),s=l.append("g").attr("transform","translate("+q+", "+(p-q)+")").attr("class","axis");var h=c.map(a,function(a){return e(a)});h=S(h);var F=(d.min(a,function(a){return a.values.length}),c(h).groupBy("key").mapValues(function(a){return a[0].values}).merge().values().flatten().value()),G=c(F).groupBy("h").map(function(a,b){return{h:+b,v:c.sumBy(a,"v")}}).value(),f=J=f||0,H=f*M,I=f*N,L=[1,K-1],R=[0,o];Q.domain(L).range(R);var $=[0,f],_=[p-2*q,0];O.domain($).range(_),P.domain($).range(_),x.selectAll("path").data(h).attr("d",function(a){return T(a.values)}).attr("fill",function(){return"url(#"+u.attr("id")+")"}),y.selectAll("path").data(h).attr("d",function(a){return U(a.values)}).attr("fill",function(){return"url(#"+v.attr("id")+")"}),z.selectAll("path").data(h).attr("d",function(a){return V(a.values)}).attr("fill",function(){return"url(#bolt_pattern)"}),k.selectAll("path").data(h).attr("d",function(a){return V(a.values)}).attr("fill","#ffffff"),A.select(".threshold").attr("x1",q).attr("y1",q+O(H)).attr("x2",o).attr("y2",q+O(H)),A.select(".danger").attr("x1",q).attr("y1",q+O(I)).attr("x2",o).attr("y2",q+O(I)),A.append("text").text("Threshold").attr("x",q+q/2).attr("y",O(H)+q/2),A.append("text").text("Demand peaks").attr("class","danger").attr("x",q+q/2).attr("y",O(I)+q/2),A.selectAll(".arealine").data(h).attr("d",function(a){return Y(a.values)}),B.attr("d",W(G)),C.attr("d",X(G)),D.selectAll("circle").data(G).attr("r",0).attr("cx",function(a){return o-q}).attr("cy",function(a){return q+O(a.v)}),E.selectAll(".label").attr("opacity",0).attr("transform",function(a){return"translate("+o+","+(q+O(c.last(G).v))+")"}),E.select(".toplabel").attr("opacity",1).append("text").attr("class","tot_value").attr("y",10).text(c.last(G).v+" w"),E.select(".storlabel").append("text").attr("class","tot_value").attr("y",10).text(c.last(G).v+" w"),E.selectAll(".label-area").data(a).append("text").text(function(a){return a.key}).attr("y",10)}function g(a,b,e){if(c.isEmpty(a))return console.error("data is empty");e||c.each(a,function(a){a.values.shift(),a.values=c.map(a.values,function(b,c){return c>0&&(a.values[c-1].v=b.v),b.h--,b})}),a=S(a);var f=d.min(a,function(a){return a.values.length}),g=c(a).groupBy("key").mapValues(function(a){return a[0].values.slice(0,f)}).merge().values().flatten().value(),h=c(g).groupBy("h").map(function(a,b){return{h:+b,v:c.sumBy(a,"v")}}).value(),i=J||c.maxBy(h,"v").v,j=J*M,l=[1,K-1],m=[0,o];Q.domain(l).range(m);var n=[0,i],r=[p-2*q,0];O.domain(n).range(r),b?P.domain(n).range([q+O(j+L),O(j)]):P.domain(n).range(r),R.domain(r).range(n),x.transition().attr("opacity",function(){return b?.5:1}),x.selectAll("path").data(a).transition().duration(function(){return b&&e?H:0}).delay(G).ease(I).attr("d",function(a){return T(a.values)}).attr("opacity",function(){return b?.2:.4}),y.transition().attr("opacity",.5),y.selectAll("path").data(a).transition().duration(function(){return b&&e?H:0}).delay(G).ease(I).attr("d",function(a){return U(a.values)}),z.selectAll("path").transition().duration(function(){return b&&e?H:0}).delay(G).ease(I).attr("d",function(a){return V(h)}),k.selectAll("path").data(a).transition().duration(function(){return b&&e?H:0}).delay(G).ease(I).attr("d",function(a){return U(a.values)}),v.selectAll(".storstop").transition().duration(H).delay(G).ease(I).attr("stop-color",function(){return b?"#2AFD95":"#5738FF"}),A.selectAll(".arealine").data(a).transition().duration(function(){return b&&e?H:0}).attr("d",function(a){return Y(a.values)}).attr("stroke-width",function(){return 0}).style("stroke-opacity",function(){return b?.3:1}),B.transition().delay(0).duration(function(){return b&&e?H:0}).delay(0).ease(I).attr("d",W(h)).attr("stroke-width",function(){return b?0:3}).attr("stroke-opacity",function(){return b?0:1}),C.transition().delay(0).duration(function(){return b&&e?H:0}).delay(0).ease(I).attr("d",X(h)).style("stroke-width",function(){return b?3:0}),D.select(".topcircle").transition().duration(function(){return e?H:H+100}).ease(I).delay(245).attr("r",function(){return b?0:5}).attr("cx",function(){return Q(K-1)-.6*q}).attr("cy",function(){return q+O(c.last(h).v)}),E.select(".toplabel").transition().duration(function(){return e?H:H+100}).ease(I).delay(245).attr("transform",function(a){var d=O(c.last(h).v),e=P(c.last(h).v);return b?(0!=d&&0!=e&&e+10>=d&&(d=e-20),"translate("+(o-5)+","+(q+d)+")"):"translate("+(o-5)+","+(q+d)+")"}).select(".tot_value").text(c.last(h).v+" w"),D.select(".storcircle").transition().duration(function(){return b?H:H/2}).ease(I).attr("r",function(){return b?"5":"0"}).attr("cx",function(){return Q(K-1)-.6*q}).attr("cy",function(){return q+P(c.last(h).v)}),E.select(".storlabel").transition().duration(function(){return b?H:H/2}).ease(I).attr("transform",function(a){return"translate("+(o-5)+","+(q+P(c.last(h).v))+")"}).attr("opacity",function(){return b?1:0}).select(".tot_value").text(Math.round(R(P(c.last(h).v)))+" w"),E.selectAll(".label-area").data(a).transition().duration(function(){return b?H:H/2}).ease(I).delay(245).attr("opacity",function(a){return c.last(a.values).v>0?1:0}).attr("transform",function(a){var b=c.last(a.values);return"translate("+(o-(1.5*q+3))+","+(q+O(b.y+b.y0))+")"})}function h(a,b,c,d,e,h){var j=this;return j.update=g,j.container=i=a,K=c,M=e,N=h,f(b,d),j}var i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F="basis",G=0,H=450,I="quad",J=null,K=30,L=50,M=0,N=0,O=d.scale.linear(),P=d.scale.linear(),Q=d.scale.linear(),R=d.scale.linear(),S=d.layout.stack().values(function(a){return a.values}).x(function(a,b){return b}).y(function(a){return a.v}),T=d.svg.area().x(function(a,b){return q+Q(b)}).y0(function(a){return p-q}).y1(function(a){return q+O(a.y+a.y0)}).interpolate(F),U=d.svg.area().x(function(a,b){return q+Q(b)}).y0(function(a){return p-q}).y1(function(a){return q+P(a.y+a.y0)}).interpolate(F),V=d.svg.area().x(function(a,b){return q+Q(b)}).y0(function(a){var b=O(a.v);P(a.v);return q+b}).y1(function(a){return q+P(a.v)}).interpolate(F),W=d.svg.line().x(function(a,b){return q+Q(b)}).y(function(a,b){return q+O(a.v)}).interpolate(F),X=d.svg.line().x(function(a,b){return q+Q(b)}).y(function(a,b){return q+P(a.v)}).interpolate(F),Y=d.svg.line().x(function(a,b){return q+Q(b)}).y(function(a,b){return q+O(a.y+a.y0)}).interpolate(F),Z='<svg id="teamAreaChart" viewBox="0 0 600 420">  <defs id="pattern_wrap">    <pattern id="bolt_pattern" patternUnits="userSpaceOnUse" width="37" height="37">      <image xlink:href="assets/pattern_bolt.svg" x="0" y="0" width="37" height="37"></image>    </pattern>  </defs></svg>';a.StackedAreaChart=h}(window,window.jQuery,window._,window.d3),window.dragQueer={init:init},function(a,b){"use strict";a.Simulator=a.Simulator||{};var c=[{key:"Cooling",icon:"icon_cooling",uid:["B5C43A2A","95E8432A","1EF3E8C1"],status:"off",values:[],maxV:4e3},{key:"Brewing",icon:"icon_brewing",uid:["C5DA2C2A","857F3A2A","3E99E9C1"],status:"off",values:[],maxV:2e3},{key:"Drying",icon:"icon_drying",uid:["75423F2A","25FB392A","4E8FE9C1"],status:"off",values:[],maxV:1500},{key:"Heating",icon:"icon_heating",uid:["3549482A","8517412A","8EA8E9C1"],status:"off",values:[],maxV:1200},{key:"Working",icon:"icon_working",uid:["A5312E2A","C59E482A","A5DA422A"],status:"off",values:[],maxV:300},{key:"Ironing",icon:"icon_ironing",uid:["A5312E2A","C59E482A","A5DA422A"],status:"off",values:[],maxV:600}],d=["65AB332A","35AA462A","75A1322A"],e={sampling_rate:1200,appliances:c,num_of_appliances:c.length,rfidReaders:4,dataset_length:30,storageUid:d,threshFactor:.5,dangerFactor:.85};b.defaultsDeep(a.Simulator,e)}(window,window._),function(a,b,c,d,e){"use strict";function f(a,c){if(a&&c){var d=v[a];d.status="on",b(".appliance#app"+(+a+1)).addClass("on"),h(d,c)}}function g(a,c){if(a&&c){var d=v[a];b(".appliance#app"+(+a+1)).removeClass("on"),d.status="off",h(d,c)}}function h(a,b){var d=t[b-1];if("on"==a.status)d.addClass("on"),d.data().reader.connectedAppliances.push(a),u.push(a),d.find("h4").text(a.key),d.find("label").text(a.maxV+"w");else if(c.pull(d.data().reader.connectedAppliances,a),c.pull(u,a),c.isEmpty(d.data().reader.connectedAppliances))d.removeClass("on"),d.find("h4").text("Plug in an appliance"),d.find("label").text("");else{var e=c.last(d.data().reader.connectedAppliances);d.find("h4").text(e.key),d.find("label").text(e.maxV+"w")}u=c.uniq(u),I&&(clearTimeout(I),I=null),I=setTimeout(p,H*F),setTimeout(function(){E||(n(),o())},0)}function i(){F=e.sampling_rate,v=e.appliances;var a=b("#power #power-strip #socket_temp").removeAttr("id");a.remove(),c.times(e.rfidReaders-1,function(c){var d=a.clone();d.data("reader",{id:c+1,connectedAppliances:[]}),t.push(d),b("#power #power-strip").append(d)});var d=b("#bucket #placeholders #placeholder_temp").removeAttr("id"),f=b("#bucket #appliances #app_temp").removeAttr("id");d.remove(),f.remove(),c.each(v,function(a,g){var h=f.clone();h.attr("id","app"+(g+1)),b("#bucket #placeholders").append(d.clone()),b("#bucket #appliances").append(h),h.find("#"+a.icon).show(),c.times(e.dataset_length,function(b){var c=0,d={h:b,v:c};a.values.push(d)})}),C=c.sumBy(c(v).sortBy("maxV").reverse().take(e.rfidReaders-1).value(),"maxV"),C+=D,y=C*e.threshFactor,z=C*e.dangerFactor}function j(){x=c.sumBy(u,"maxV"),k(),B.update(v,w),l()}function k(){c.each(v,function(a){var b="on"===a.status?{h:a.values.length,v:a.maxV}:{h:a.values.length,v:0};a.values.push(b)})}function l(){var a=x/C*100;a>100&&(a=100),b("#demand > span").css({height:a+"%","background-position-y":100-a+"%"}),b('[id*="arrow"]').removeClass("animate reverse fast"),b("#grid svg g#grid polyline").removeClass("shake-constant"),b("#grid svg g#copy_storage g").removeClass("visible"),b("#grid svg g#storage g").removeClass("visible"),!w&&!c.isEmpty(u)&&x>=z-A?(b("#arrow_GtoB").addClass("animate fast"),b("#grid svg g#grid polyline").addClass("shake-constant"),b("#grid svg g#grid polyline").addClass("shake-opacity"),b("#grid svg g#storage g#storageOFF").addClass("visible"),b("#grid svg g#copy_storage g#copy_storageOFF").addClass("visible"),b("#grid svg g#copy_storage g#warning_storageOFF").addClass("visible")):w||c.isEmpty(u)?w&&c.isEmpty(u)?(b("#arrow_GtoB").addClass("animate"),b("#arrow_StoB").addClass("animate reverse"),b("#grid svg g#storage g#storageIN").addClass("visible"),b("#grid svg g#copy_storage g#copy_storageIN").addClass("visible")):w&&x>y?(b("#arrow_GtoB").addClass("animate"),b("#arrow_StoB").addClass("animate"),b("#grid svg g#storage g#storageOUT").addClass("visible"),b("#grid svg g#copy_storage g#copy_storageOUT").addClass("visible")):w&&!c.isEmpty(u)?(b("#arrow_GtoB").addClass("animate"),b("#arrow_StoB").addClass("animate reverse"),b("#grid svg g#storage g#storageIN").addClass("visible"),b("#grid svg g#copy_storage g#copy_storageIN").addClass("visible")):b("#grid svg g#storage g#storageOFF").addClass("visible"):(b("#arrow_GtoB").addClass("animate"),b("#grid svg g#storage g#storageOFF").addClass("visible"),b("#grid svg g#copy_storage g#copy_storageOFF").addClass("visible"))}function m(a){a?(b("main").css("background-position-y","0%"),b("article#storage").removeClass("on"),w=!1):(b("main").css("background-position-y","100%"),b("article#storage").addClass("on"),w=!0);var c=!0;return l(),B.update(v,w,c)}function n(){b(".arealine").transition({x:"-37px",duration:F-2*G,easing:"easeInOutSine"}),b(".topline path").transition({x:"-37px",duration:F-2*G,easing:"easeInOutSine"}),b(".areas path").transition({x:"-37px",duration:F-2*G,easing:"easeInOutSine"}),setTimeout(function(){j(),b(".arealine").css({x:"0px"}),b(".topline path").css({x:"0px"}),b(".areas path").css({x:"0px"})},F-G)}function o(){E&&p(),E=setInterval(n,F),I&&(clearTimeout(I),I=null),I=setTimeout(p,H*F),b("#clock svg line").css("animation-play-state","running")}function p(){clearInterval(E),E=null,I&&(clearTimeout(I),I=null),b("#clock svg line").css("animation-play-state","paused")}function q(){b(a).on("customEv",function(a,b){switch(b){case" ":E?p():o();break;case"0":case"s":m(w);break;case"1":case"2":var c=+b-1,d=v[c];d.status="off"==d.status?"on":"off",h(d,1);break;case"3":case"6":var c=+b-1,d=v[c];d.status="off"==d.status?"on":"off",h(d,2);break;case"4":case"5":var c=+b-1,d=v[c];d.status="off"==d.status?"on":"off",h(d,3);break;default:return}})}function r(){b("article#storage #toggle svg #switch_OFF").on("click",function(){m(!0)}),b("article#storage #toggle svg #switch_ON").on("click",function(){m(!1)})}function s(){FastClick.attach(document.body),i(),B=new StackedAreaChart("#monitor-chart",v,e.dataset_length,C,e.threshFactor,e.dangerFactor),q(),r(),m(!w),j(),dragQueer.init()}var t=[],u=[],v=[],w=!1,x=0,y=0,z=0,A=1e3,B=null,C=0,D=0,E=null,F=0,G=75,H=4,I=null;b(document).ready(s),b(a).keydown(function(c){b(a).trigger("customEv",c.key)}),a.APP={select:f,deselect:g}}(window,window.jQuery,window._,window.WebSocket,window.Simulator);