!function(a,b,c,d){"use strict";function e(a){var b=a.values,c={key:a.key,values:b.map(function(a){return{v:0}})};return c}function f(a,f){if(c.isEmpty(a))return console.error("data is empty");l=b(i).append(Z).find("svg#teamAreaChart"),m=l.attr("viewBox").split(" "),n=+m[2],p=+m[3],p+=10,q=30,r=75,o=n-r,l=d.select(l.get(0)),t=l.append("defs");var g=t.append("linearGradient").attr("id","teamAreaChart_mask_grad").attr("gradientUnits","userSpaceOnUse").attr("x1",0).attr("y1",0).attr("x2",o).attr("y2",0);g.append("stop").attr("offset",0).attr("stop-color","#000"),g.append("stop").attr("offset",q/o).attr("stop-color","#000"),g.append("stop").attr("offset",q/o).attr("stop-color","#fff"),g.append("stop").attr("offset",1-.6*q/o).attr("stop-color","#fff"),g.append("stop").attr("offset",1-q/o).attr("stop-color","#000"),g.append("stop").attr("offset",1).attr("stop-color","#000"),j=t.append("mask").attr("id","mask-border"),k=t.append("mask").attr("id","mask-area"),k.append("path").attr("class","area area-mask"),j.append("rect").attr("x",0).attr("y",0).attr("width",o).attr("height",p).attr("fill","url(#teamAreaChart_mask_grad)"),u=t.append("linearGradient").attr("id","areaGrd").attr("gradientUnits","userSpaceOnUse").attr("x1",0).attr("y1",q).attr("x2",0).attr("y2",p-q),u.append("stop").attr("offset",0).attr("stop-color","#fc1c63"),u.append("stop").attr("offset",1-(M+M/1.5)).attr("stop-color","#fc1c63"),u.append("stop").attr("offset",1-M).attr("stop-color","#0555f9"),u.append("stop").attr("offset",1).attr("stop-color","#ffffff"),v=t.append("linearGradient").attr("id","storAreaGrd").attr("gradientUnits","userSpaceOnUse").attr("x1",0).attr("y1",q).attr("x2",0).attr("y2",p-q),v.append("stop").attr("offset",0).attr("stop-color","#fc1c63"),v.append("stop").attr("offset",1-(M+M/1.5)).attr("stop-color","#fc1c63"),v.append("stop").attr("class","storstop").attr("offset",1-M).attr("stop-color","#0555f9"),v.append("stop").attr("offset",1).attr("stop-color","rgba(255,255,255,.1)"),w=l.append("g").attr("class","areas").attr("mask","url(#mask-border)"),z=w.append("g").attr("class","areaIntersection").attr("mask","url(#mask-area)"),x=w.append("g").attr("class","areaTot"),y=w.append("g").attr("class","areaStorage"),A=l.append("g").attr("class","toplines").attr("mask","url(#mask-border)"),D=l.append("g").attr("class","circles"),E=l.append("g").attr("class","labels"),c.each(a,function(a){x.append("path").attr("class","area area-"+c.kebabCase(a.key)),y.append("path").attr("class","area area-"+c.kebabCase(a.key)),A.append("path").attr("class","arealine line-"+c.kebabCase(a.key)),E.append("g").attr("class","label label-area label-"+c.kebabCase(a.key))}),z.append("path").attr("class","area area-intersection"),B=A.append("g").attr("class","topline").append("path"),C=A.append("g").attr("class","topline storage").append("path"),D.append("circle").attr("class","topcircle"),E.append("g").attr("class","label toplabel").append("text").text("Energy demand"),D.append("circle").attr("class","storcircle"),E.append("g").attr("class","label storlabel").append("text").text("Energy from the grid"),A.append("line").attr("class","threshold"),A.append("line").attr("class","danger"),s=l.append("g").attr("transform","translate("+q+", "+(p-q)+")").attr("class","axis");var h=c.map(a,function(a){return e(a)});h=S(h);var F=(d.min(a,function(a){return a.values.length}),c(h).groupBy("key").mapValues(function(a){return a[0].values}).merge().values().flatten().value()),G=c(F).groupBy("h").map(function(a,b){return{h:+b,v:c.sumBy(a,"v")}}).value(),f=J=f||0,H=f*M,I=f*N,L=[1,K-1],R=[0,o];Q.domain(L).range(R);var $=[0,f],_=[p-2*q,0];O.domain($).range(_),P.domain($).range(_),x.selectAll("path").data(h).attr("d",function(a){return T(a.values)}).attr("fill",function(){return"url(#"+u.attr("id")+")"}),y.selectAll("path").data(h).attr("d",function(a){return U(a.values)}).attr("fill",function(){return"url(#"+v.attr("id")+")"}),z.selectAll("path").data(h).attr("d",function(a){return V(a.values)}).attr("fill",function(){return"url(#bolt_pattern)"}),k.selectAll("path").data(h).attr("d",function(a){return V(a.values)}).attr("fill","#fff"),A.select(".threshold").attr("x1",q).attr("y1",q+O(H)).attr("x2",o).attr("y2",q+O(H)),A.select(".danger").attr("x1",q).attr("y1",q+O(I)).attr("x2",o).attr("y2",q+O(I)),A.append("text").text("Threshold").attr("x",q+q/2).attr("y",O(H)+q/2),A.append("text").text("Demand peaks").attr("class","danger").attr("x",q+q/2).attr("y",O(I)+q/2),A.selectAll(".arealine").data(h).attr("d",function(a){return Y(a.values)}),B.attr("d",W(G)),C.attr("d",X(G)),D.selectAll("circle").data(G).attr("r",0).attr("cx",function(a){return o-q}).attr("cy",function(a){return q+O(a.v)}),E.selectAll(".label").attr("opacity",0).attr("transform",function(a){return"translate("+o+","+(q+O(c.last(G).v))+")"}),E.select(".toplabel").attr("opacity",1).append("text").attr("class","tot_value").attr("y",10).text(c.last(G).v+" w"),E.select(".storlabel").append("text").attr("class","tot_value").attr("y",10).text(c.last(G).v+" w"),E.selectAll(".label-area").data(a).append("text").text(function(a){return a.key}).attr("y",10)}function g(a,b,e){if(c.isEmpty(a))return console.error("data is empty");e||c.each(a,function(a){a.values.shift(),a.values=c.map(a.values,function(b,c){return c>0&&(a.values[c-1].v=b.v),b.h--,b})}),a=S(a);var f=d.min(a,function(a){return a.values.length}),g=c(a).groupBy("key").mapValues(function(a){return a[0].values.slice(0,f)}).merge().values().flatten().value(),h=c(g).groupBy("h").map(function(a,b){return{h:+b,v:c.sumBy(a,"v")}}).value(),i=J||c.maxBy(h,"v").v,j=J*M,l=[1,K-1],m=[0,o];Q.domain(l).range(m);var n=[0,i],r=[p-2*q,0];O.domain(n).range(r),b?P.domain(n).range([q+O(j+L),O(j)]):P.domain(n).range(r),R.domain(r).range(n),x.transition().attr("opacity",function(){return b?.5:1}),x.selectAll("path").data(a).transition().duration(function(){return b&&e?H:0}).delay(G).ease(I).attr("d",function(a){return T(a.values)}).attr("opacity",function(){return b?.2:.4}),y.transition().attr("opacity",.8),y.selectAll("path").data(a).transition().duration(function(){return b&&e?H:0}).delay(G).ease(I).attr("d",function(a){return U(a.values)}),z.selectAll("path").transition().duration(function(){return b&&e?H:0}).delay(G).ease(I).attr("d",function(a){return V(h)}),k.selectAll("path").data(a).transition().duration(function(){return b&&e?H:0}).delay(G).ease(I).attr("d",function(a){return U(a.values)}),v.selectAll(".storstop").transition().duration(H).delay(G).ease(I).attr("stop-color",function(){return b?"#55bd5a":"#0555f9"}),A.selectAll(".arealine").data(a).transition().duration(function(){return b&&e?H:0}).attr("d",function(a){return Y(a.values)}).attr("stroke-width",function(){return 0}).style("stroke-opacity",function(){return b?.3:1}),B.transition().delay(0).duration(function(){return b&&e?H:0}).delay(0).ease(I).attr("d",W(h)).attr("stroke-width",function(){return b?0:3}).attr("stroke-opacity",function(){return b?0:1}),C.transition().delay(0).duration(function(){return b&&e?H:0}).delay(0).ease(I).attr("d",X(h)).style("stroke-width",function(){return b?3:0}),D.select(".topcircle").transition().duration(function(){return e?H:H+100}).ease(I).delay(245).attr("r",function(){return b?0:5}).attr("cx",function(){return Q(K-1)-.6*q}).attr("cy",function(){return q+O(c.last(h).v)}),E.select(".toplabel").transition().duration(function(){return e?H:H+100}).ease(I).delay(245).attr("transform",function(a){return"translate("+o+","+(q+O(c.last(h).v))+")"}).select(".tot_value").text(c.last(h).v+" w"),D.select(".storcircle").transition().duration(function(){return b?H:H/2}).ease(I).attr("r",function(){return b?"5":"0"}).attr("cx",function(){return Q(K-1)-.6*q}).attr("cy",function(){return q+P(c.last(h).v)}),E.select(".storlabel").transition().duration(function(){return b?H:H/2}).ease(I).attr("transform",function(a){return"translate("+o+","+(q+P(c.last(h).v))+")"}).attr("opacity",function(){return b?1:0}).select(".tot_value").text(Math.round(R(P(c.last(h).v)))+" w"),E.selectAll(".label-area").data(a).transition().duration(function(){return b?H:H/2}).ease(I).delay(245).attr("opacity",function(a){return c.last(a.values).v>0?1:0}).attr("transform",function(a){var b=c.last(a.values);return"translate("+(o-(1.5*q+3))+","+(q+O(b.y+b.y0))+")"})}function h(a,b,c,d,e,h){var j=this;return j.update=g,j.container=i=a,K=c,M=e,N=h,f(b,d),j}var i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F="basis",G=0,H=450,I="quad",J=null,K=30,L=50,M=0,N=0,O=d.scale.linear(),P=d.scale.linear(),Q=d.scale.linear(),R=d.scale.linear(),S=d.layout.stack().values(function(a){return a.values}).x(function(a,b){return b}).y(function(a){return a.v}),T=d.svg.area().x(function(a,b){return q+Q(b)}).y0(function(a){return p-q}).y1(function(a){return q+O(a.y+a.y0)}).interpolate(F),U=d.svg.area().x(function(a,b){return q+Q(b)}).y0(function(a){return p-q}).y1(function(a){return q+P(a.y+a.y0)}).interpolate(F),V=d.svg.area().x(function(a,b){return q+Q(b)}).y0(function(a){var b=O(a.v);P(a.v);return q+b}).y1(function(a){return q+P(a.v)}).interpolate(F),W=d.svg.line().x(function(a,b){return q+Q(b)}).y(function(a,b){return q+O(a.v)}).interpolate(F),X=d.svg.line().x(function(a,b){return q+Q(b)}).y(function(a,b){return q+P(a.v)}).interpolate(F),Y=d.svg.line().x(function(a,b){return q+Q(b)}).y(function(a,b){return q+O(a.y+a.y0)}).interpolate(F),Z='<svg id="teamAreaChart" viewBox="0 0 600 400">  <defs id="pattern_wrap">    <pattern id="bolt_pattern" patternUnits="userSpaceOnUse" width="37" height="37">      <image xlink:href="../assets/pattern_bolt.svg" x="0" y="0" width="37" height="37"></image>    </pattern>  </defs></svg>';a.StackedAreaChart=h}(window,window.jQuery,window._,window.d3),function(a,b){"use strict";a.Simulator=a.Simulator||{};var c=[{key:"Cooling",icon:"icon_cooling.svg",uid:["B5C43A2A","95E8432A","1EF3E8C1"],status:"off",values:[],maxV:4e3},{key:"Brewing",icon:"icon_brewing.svg",uid:["C5DA2C2A","857F3A2A","3E99E9C1"],status:"off",values:[],maxV:2e3},{key:"Drying",icon:"icon_drying.svg",uid:["75423F2A","25FB392A","4E8FE9C1"],status:"off",values:[],maxV:1500},{key:"Heating",icon:"icon_heating.svg",uid:["3549482A","8517412A","8EA8E9C1"],status:"off",values:[],maxV:1200},{key:"Working",icon:"icon_working.svg",uid:["A5312E2A","C59E482A","A5DA422A"],status:"off",values:[],maxV:300}],d=["65AB332A","35AA462A","75A1322A"],e={sampling_rate:1200,appliances:c,num_of_appliances:c.length,rfidReaders:4,dataset_length:30,storageUid:d,threshFactor:.5,dangerFactor:.85};b.defaultsDeep(a.Simulator,e)}(window,window._),function(a,b,c,d,e){"use strict";function f(a,d){var e=r[d-1];if("on"==a.status)e.addClass("on"),e.data().reader.connectedAppliances.push(a),s.push(a),e.find("span").css("background-image",'url("assets/'+a.icon+'")'),e.find("h4").text(a.key),e.find("label").text(a.maxV+"w");else if(c.pull(e.data().reader.connectedAppliances,a),c.pull(s,a),c.isEmpty(e.data().reader.connectedAppliances))e.removeClass("on"),e.find("span").css("background-image",'url("assets/icon_arrow_down.svg")'),e.find("h4").text(""),e.find("label").text("");else{var f=c.last(e.data().reader.connectedAppliances);e.find("span").css("background-image",'url("assets/'+f.icon+'")'),e.find("h4").text(f.key),e.find("label").text(f.maxV+"w")}c.isEmpty(s)?(b("#appliances .active").hide(),b("#appliances .inactive").show()):(b("#appliances .inactive").hide(),b("#appliances .active").show()),G&&(clearTimeout(G),G=null),G=setTimeout(n,F*D),C||(l(),m())}function g(){D=e.sampling_rate,t=e.appliances,c.times(e.rfidReaders-1,function(a){var c=b('<li class="reader"><span></span><h4></h4><label></label></li>');c.data("reader",{id:a+1,connectedAppliances:[]}),r.push(c),b("#readers").find("ul").append(c)}),c.each(t,function(a){c.times(e.dataset_length,function(b){var c=0,d={h:b,v:c};a.values.push(d)})}),A=c.sumBy(c(t).sortBy("maxV").reverse().take(e.rfidReaders-1).value(),"maxV"),A+=B,w=A*e.threshFactor,x=A*e.dangerFactor,b("#appliances .active").hide(),b("#appliances .inactive").show()}function h(){v=c.sumBy(s,"maxV"),i(),z.update(t,u),j()}function i(){c.each(t,function(a){var b="on"===a.status?{h:a.values.length,v:a.maxV}:{h:a.values.length,v:0};a.values.push(b)})}function j(){var a=v/A*100;a>100&&(a=100),b("#demand > span").css({width:a+"%","background-position-x":a+"%"}),v>w?(b("#storage .active #dot #bolt").fadeOut(),b("#storage .active #dot").css("transform","translateY(-40px)")):(b("#storage .active #dot #bolt").fadeIn(),b("#storage .active #dot").css("transform","translateY(0)")),b('g[id*="arrow"]').removeClass("animate reverse fast"),b("#grid svg g#theGrid #icoBolt").removeClass("shake-constant"),b("#grid svg #alert").removeClass("visible"),b("#grid svg #storage").removeClass("visible"),!u&&!c.isEmpty(s)&&v>=x-y?(b("#arrowGtoH").addClass("animate fast"),b("#grid svg g#theGrid #icoBolt").addClass("shake-constant"),b("#grid svg g#theGrid #icoBolt").addClass("shake-opacity"),b("#grid svg #alert").addClass("visible")):u||c.isEmpty(s)?u&&c.isEmpty(s)?(b("#grid svg #storage").addClass("visible"),b("#arrowGtoH").addClass("animate"),b("#arrowStoH").addClass("animate reverse")):u&&v>w?(b("#grid svg #storage").addClass("visible"),b("#arrowGtoH").addClass("animate"),b("#arrowStoH").addClass("animate")):u&&!c.isEmpty(s)&&(b("#grid svg #storage").addClass("visible"),b("#arrowGtoH").addClass("animate"),b("#arrowStoH").addClass("animate reverse")):b("#arrowGtoH").addClass("animate")}function k(a){a?(b("#storage .active").hide(),b("#storage .inactive").show(),b("main").css("background-position-y","0%"),b("article#storage").removeClass("on"),u=!1):(b("#storage .inactive").hide(),b("#storage .active").show(),b("main").css("background-position-y","100%"),b("article#storage").addClass("on"),u=!0);var c=!0;return j(),z.update(t,u,c)}function l(){b(".arealine").transition({x:"-37px",duration:D-2*E,easing:"easeInOutSine"}),b(".topline path").transition({x:"-37px",duration:D-2*E,easing:"easeInOutSine"}),b(".areas path").transition({x:"-37px",duration:D-2*E,easing:"easeInOutSine"}),setTimeout(function(){h(),b(".arealine").css({x:"0px"}),b(".topline path").css({x:"0px"}),b(".areas path").css({x:"0px"})},D-E)}function m(){C&&n(),C=setInterval(l,D),G&&(clearTimeout(G),G=null),G=setTimeout(n,F*D),b("#clock svg line").css("animation-play-state","running")}function n(){clearInterval(C),C=null,G&&(clearTimeout(G),G=null),b("#clock svg line").css("animation-play-state","paused")}function o(){b(a).on("customEv",function(a,b){switch(b){case" ":C?n():m();break;case"0":case"s":k(u);break;case"1":case"2":var c=+b-1,d=t[c];d.status="off"==d.status?"on":"off",f(d,1);break;case"3":var c=+b-1,d=t[c];d.status="off"==d.status?"on":"off",f(d,2);break;case"4":case"5":var c=+b-1,d=t[c];d.status="off"==d.status?"on":"off",f(d,3);break;default:return}})}function p(){H&&(H.onopen=function(a){console.info("open ws connection!",a)},H.onmessage=function(a){var b=JSON.parse(a.data.split(" from ")[0]);if(console.log("message received",a,b),0===b.id){var d="off"===c.lowerCase(b.state),g=c.includes(e.storageUid,b.uid);return g?k(d):console.error("Invalid Storage UID:",b)}var h=c.find(t,function(a){return c.includes(a.uid,b.uid)});if(!h)return console.error("Invalid UID:",b);h.status=c.lowerCase(b.state);var i=b.id;return f(h,i)},H.onclose=function(a){console.info("closed ws connection!",a),H=null,setTimeout(function(){H=new d(I),p()},J)},H.onerror=function(a){console.error("error on ws connection!",a)})}function q(){L?(clearInterval(L),L=null,K=!1):K=!K,K?(m(),L=setInterval(function(){var c=Math.floor(10*Math.random());switch(c){case 0:case 7:case 9:b(a).trigger("customEv","s");break;case 1:case 2:case 3:case 4:case 5:b(a).trigger("customEv",c.toString());break;default:return}},M)):(n(),clearInterval(L),L=null)}var r=[],s=[],t=[],u=!1,v=0,w=0,x=0,y=1e3,z=null,A=0,B=0,C=null,D=0,E=75,F=4,G=null,H=null,I="ws://7.7.7.7:9000",I="",J=1e3,K=!1,L=null,M=1250;!function(){g(),z=new StackedAreaChart("#monitor-chart",t,e.dataset_length,A,e.threshFactor,e.dangerFactor),I&&(H=new d(I)),p(),o(),k(!u),h()}(),b(a).keydown(function(c){return c.altKey&&66===c.keyCode?q():void b(a).trigger("customEv",c.key)})}(window,window.jQuery,window._,window.WebSocket,window.Simulator);